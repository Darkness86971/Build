# GitHub Actions Workflow for Android APK Build using Buildozer
# This workflow is the final, most robust version to handle all CI environment issues.

name: Android APK Build

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build_android:
    # Buildozer requires a Linux environment
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        # Fetch all history for setuptools_scm to work correctly
        fetch-depth: 0

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Buildozer, Cython, and System Dependencies
      run: |
        # Install Buildozer and Cython (fix for "Cython not found")
        pip install buildozer cython
        
        # Install system dependencies for Android build
        sudo apt-get update
        # Removed libtinfo5 (fix for "Unable to locate package libtinfo5")
        sudo apt-get install -y \
          git zip unzip openjdk-17-jdk autoconf libtool pkg-config zlib1g-dev \
          libncurses5-dev libncursesw5-dev cmake libffi-dev libssl-dev

    - name: Create buildozer.spec file
      run: |
        cat << EOF > buildozer.spec
        [app]
        title = Ransomware Educational Demo
        package.name = ransomware_demo
        package.domain = org.test
        version = 0.1
        requirements = python3, kivy, android
        main.py = ransomware_demo.py
        source.dir = .  # Explicitly set source directory (fix for "source.dir is missing")
        source.include_exts = py,png,jpg,kv,atlas
        source.exclude_dirs = tests, bin, venv
        android.ndk = 25b
        android.sdk = 33
        android.api = 33
        android.minapi = 21
        android.target = 33
        orientation = portrait
        android.release = False
        android.keystore = debug.keystore
        android.keystore.password = android
        android.keyalias = androiddebugkey
        android.keyalias.password = android

        [buildozer]
        log_level = 2
        EOF

    - name: Accept Android SDK Licenses (Robust Fix)
      run: |
        # This is the most reliable way to accept licenses in a non-interactive CI environment.
        # It pipes 'y' to the license prompt, which is what Buildozer is waiting for.
        yes | buildozer android debug --download-only

    - name: Run Buildozer to create debug APK
      # The 'android debug' command will download NDK, SDK, and build the APK.
      # We use the standard command here, as the license acceptance is handled by the next step.
      run: buildozer android debug

    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: bin/*.apk
        retention-days: 5
        
