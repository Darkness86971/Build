# GitHub Actions Workflow for Android APK Build using Buildozer
# This workflow is separate from the original multi-OS/multi-version test job
# because the Android build process is highly specific and resource-intensive.

name: Android APK Build

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build_android:
    # Buildozer requires a Linux environment
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        # Fetch all history for setuptools_scm to work correctly
        fetch-depth: 0

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Buildozer and dependencies
      run: |
        # Install Buildozer
        pip install buildozer cython
        
        # Install system dependencies for Android build
        sudo apt-get update
        sudo apt-get install -y \
          git zip unzip openjdk-17-jdk python3-pip autoconf libtool pkg-config zlib1g-dev \
          libncurses5-dev libncursesw5-dev cmake libffi-dev libssl-dev

    - name: Create buildozer.spec file
      # The buildozer.spec file is created here to ensure it's present for the build.
      # NOTE: The original application uses Tkinter, which is NOT supported by Python-for-Android.
      # This build will likely FAIL unless the application is converted to use Kivy or another supported framework.
      run: |
        cat << EOF > buildozer.spec
        [app]
        title = Ransomware Educational Demo
        package.name = ransomware_demo
        package.domain = org.test
        version = 0.1
        # IMPORTANT: Tkinter is not supported by Python-for-Android.
        # The build will proceed, but the resulting APK will not run the GUI.
        # Kivy is included as a placeholder to satisfy the build system.
        requirements = python3, kivy, android
        main.py = ransomware_demo.py
        source.dir = .  # Explicitly set source directory to current directory
        source.include_exts = py,png,jpg,kv,atlas
        source.exclude_dirs = tests, bin, venv
        android.ndk = 25b
        android.sdk = 33
        android.api = 33
        android.minapi = 21
        android.target = 33
        orientation = portrait
        android.release = False
        android.keystore = debug.keystore
        android.keystore.password = android
        android.keyalias = androiddebugkey
        android.keyalias.password = android

        [buildozer]
        log_level = 2
        EOF

    - name: Run Buildozer to create debug APK
      # The 'android debug' command will download NDK, SDK, and build the APK.
      # This step can take a long time on the first run due to large downloads.
      run: buildozer android debug

    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: bin/*.apk
        retention-days: 5
        
